generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum TemplateType {
  PIC
  PGD
  NPS
}

enum TemplateScope {
  GLOBAL
  TENANT
}

enum TemplateVersionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
  ARCHIVED
}

enum ProjectKState {
  PENDING_VALIDATION
  VALIDATED
  RELEASED
}

enum SignalPolicy {
  HARD_BLOCK
  SOFT_ALERT
}

enum SignalKind {
  PAYMENT
  PERMITS_PARKING
  PGD_BLOCKING_DOCS
  CRATES
  THIRD_PARTIES
}

enum PgdItemStatus {
  MISSING
  SUBMITTED
  VALIDATED
  REJECTED
}

enum PgdVisibility {
  CLIENT_VIEW
  INTERNAL_VIEW
}

enum PgdResponsible {
  CLIENT
  SUPERVISOR
  DRIVER
  INTERNAL
}

enum PgdFileType {
  PDF
  PHOTO
  SIGNATURE
  OTHER
}

model User {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  email        String   @unique
  phone        String
  role         String
  status       String
  department   String?
  joinDate     String
  points       Int      @default(0)
  rating       Float    @default(0)
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  templateVersionsCreated  TemplateVersion[] @relation("TemplateCreatedBy")
  templateVersionsApproved TemplateVersion[] @relation("TemplateApprovedBy")
  templateVersionsRejected TemplateVersion[] @relation("TemplateRejectedBy")

  projectSignalsAcked      ProjectSignal[]   @relation("ProjectSignalAckBy")
  projectPgdsApplied       ProjectPgd[]      @relation("ProjectPgdAppliedBy")
  projectPgdItemsValidated ProjectPgdItem[]  @relation("ProjectPgdItemValidatedBy")

  @@map("osi_users")
}

model Client {
  id            String    @id @default(cuid())
  code          String    @unique
  name          String
  email         String
  phone         String
  address       String
  type          String
  status        String
  totalServices Int       @default(0)
  lastService   String?
  createdAt     String
  projects      Project[]

  @@map("osi_clients")
}

model Project {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  clientId   String
  clientName String
  status     String
  startDate  String
  endDate    String?
  kState     ProjectKState @default(PENDING_VALIDATION)
  kValidatedAt DateTime?
  kReleasedAt  DateTime?
  osiCount   Int      @default(0)
  totalValue Float    @default(0)
  assignedTo String?
  notes      String?
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  osis       Osi[]
  signals    ProjectSignal[]
  pgd        ProjectPgd?

  @@map("osi_projects")
}

model ProjectSignal {
  id        String      @id @default(cuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  kind      SignalKind
  policy    SignalPolicy
  warnAt    DateTime?
  dueAt     DateTime?

  doneAt    DateTime?

  ackAt     DateTime?
  ackNote   String?
  ackById   String?
  ackBy     User?       @relation("ProjectSignalAckBy", fields: [ackById], references: [id])

  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([projectId, kind])
  @@index([projectId, kind])
  @@map("osi_project_signals")
}

model ProjectPgd {
  id          String   @id @default(cuid())
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  templateId        String
  template          Template @relation(fields: [templateId], references: [id])
  templateVersionId String
  templateVersion   TemplateVersion @relation("ProjectPgdTemplateVersion", fields: [templateVersionId], references: [id])

  appliedAt   DateTime @default(now())
  appliedById String?
  appliedBy   User?    @relation("ProjectPgdAppliedBy", fields: [appliedById], references: [id])

  items      ProjectPgdItem[]

  @@map("osi_project_pgd")
}

model ProjectPgdItem {
  id           String   @id @default(cuid())
  projectPgdId String
  projectPgd   ProjectPgd @relation(fields: [projectPgdId], references: [id], onDelete: Cascade)

  name           String
  visibility     PgdVisibility
  responsible    PgdResponsible
  isBlocking     Boolean @default(false)
  expectedFileType PgdFileType @default(OTHER)
  serviceTags    String[]

  status       PgdItemStatus @default(MISSING)
  validatedAt  DateTime?
  validatedById String?
  validatedBy  User?    @relation("ProjectPgdItemValidatedBy", fields: [validatedById], references: [id])
  note         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([projectPgdId, status])
  @@map("osi_project_pgd_items")
}

model Osi {
  id            String  @id @default(cuid())
  code          String  @unique
  projectId     String
  projectCode   String
  clientId      String
  clientName    String
  status        String
  type          String
  origin        String
  destination   String
  scheduledDate String
  createdAt     String
  assignedTo    String?
  team          String[]
  vehicles      String[]
  value         Float
  notes         String?
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("osi_osis")
}

model Template {
  id        String        @id @default(cuid())
  type      TemplateType
  name      String
  scope     TemplateScope @default(TENANT)
  tenantId  String?
  isActive  Boolean       @default(true)

  publishedVersionId String?
  publishedVersion   TemplateVersion? @relation("TemplatePublishedVersion", fields: [publishedVersionId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  versions  TemplateVersion[]
  projectPgds ProjectPgd[]

  @@index([type, tenantId])
  @@unique([type, name, tenantId], name: "type_name_tenantId")
  @@map("osi_templates")
}

model TemplateVersion {
  id            String                @id @default(cuid())
  templateId    String
  template      Template              @relation(fields: [templateId], references: [id], onDelete: Cascade)

  version       Int
  status        TemplateVersionStatus @default(DRAFT)

  contentJson   Json?
  contentHtml   String?

  changeSummary String?
  requestedAt   DateTime?
  approvedAt    DateTime?
  publishedAt   DateTime?

  createdById   String
  approvedById  String?
  rejectedById  String?

  createdBy     User                  @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  approvedBy    User?                 @relation("TemplateApprovedBy", fields: [approvedById], references: [id])
  rejectedBy    User?                 @relation("TemplateRejectedBy", fields: [rejectedById], references: [id])

  baseVersionId String?
  baseVersion   TemplateVersion?      @relation("TemplateBaseVersion", fields: [baseVersionId], references: [id])
  derivedVersions TemplateVersion[]   @relation("TemplateBaseVersion")

  // Opposite side for Template.publishedVersion
  publishedForTemplates Template[]    @relation("TemplatePublishedVersion")
  projectPgdsLocked     ProjectPgd[]  @relation("ProjectPgdTemplateVersion")

  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@unique([templateId, version])
  @@index([status, createdAt])
  @@index([templateId, status])
  @@map("osi_template_versions")
}
