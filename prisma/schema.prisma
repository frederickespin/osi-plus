generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum TemplateType {
  PIC
  PGD
  NPS
}

enum TemplateScope {
  GLOBAL
  TENANT
}

enum TemplateVersionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  REJECTED
  ARCHIVED
}

model User {
  id           String   @id @default(cuid())
  code         String   @unique
  name         String
  email        String   @unique
  phone        String
  role         String
  status       String
  department   String?
  joinDate     String
  points       Int      @default(0)
  rating       Float    @default(0)
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  templateVersionsCreated  TemplateVersion[] @relation("TemplateCreatedBy")
  templateVersionsApproved TemplateVersion[] @relation("TemplateApprovedBy")
  templateVersionsRejected TemplateVersion[] @relation("TemplateRejectedBy")
}

model Client {
  id            String    @id @default(cuid())
  code          String    @unique
  name          String
  email         String
  phone         String
  address       String
  type          String
  status        String
  totalServices Int       @default(0)
  lastService   String?
  createdAt     String
  projects      Project[]
}

model Project {
  id         String   @id @default(cuid())
  code       String   @unique
  name       String
  clientId   String
  clientName String
  status     String
  startDate  String
  endDate    String?
  osiCount   Int      @default(0)
  totalValue Float    @default(0)
  assignedTo String?
  notes      String?
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  osis       Osi[]
}

model Osi {
  id            String  @id @default(cuid())
  code          String  @unique
  projectId     String
  projectCode   String
  clientId      String
  clientName    String
  status        String
  type          String
  origin        String
  destination   String
  scheduledDate String
  createdAt     String
  assignedTo    String?
  team          String[]
  vehicles      String[]
  value         Float
  notes         String?
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model Template {
  id        String        @id @default(cuid())
  type      TemplateType
  name      String
  scope     TemplateScope @default(TENANT)
  tenantId  String?
  isActive  Boolean       @default(true)

  publishedVersionId String?
  publishedVersion   TemplateVersion? @relation("TemplatePublishedVersion", fields: [publishedVersionId], references: [id])

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  versions  TemplateVersion[]

  @@index([type, tenantId])
  @@unique([type, name, tenantId], name: "type_name_tenantId")
}

model TemplateVersion {
  id            String                @id @default(cuid())
  templateId    String
  template      Template              @relation(fields: [templateId], references: [id], onDelete: Cascade)

  version       Int
  status        TemplateVersionStatus @default(DRAFT)

  contentJson   Json?
  contentHtml   String?

  changeSummary String?
  requestedAt   DateTime?
  approvedAt    DateTime?
  publishedAt   DateTime?

  createdById   String
  approvedById  String?
  rejectedById  String?

  createdBy     User                  @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  approvedBy    User?                 @relation("TemplateApprovedBy", fields: [approvedById], references: [id])
  rejectedBy    User?                 @relation("TemplateRejectedBy", fields: [rejectedById], references: [id])

  baseVersionId String?
  baseVersion   TemplateVersion?      @relation("TemplateBaseVersion", fields: [baseVersionId], references: [id])

  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt

  @@unique([templateId, version])
  @@index([status, createdAt])
  @@index([templateId, status])
}
